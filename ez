#!/usr/bin/env bash

if [ ! -n "$TMUX" ]; then
  echo "Not in a tmux session"
  exit -1
fi

RED='\033[0;31m'   # Color red
GREEN='\033[0;32m' # Color green
NC='\033[0m'       # No Color (reset)

cmd="$1"
cmds=("cp" "mv", "cd")

declare -a args_arr
declare -a flags_arr
declare -a ez_flags_arr

# check if the cmd is supported
if [[ ! "${cmds[@]}" =~ "$cmd" ]]; then
  echo "$cmd is not a valid command with tmux-ez"
  exit -2
fi

# For debugging
function echo_args() {
  for arg in "$@"; do
    echo "arg: $arg"
  done
}

#echo_args "$@"

function get_pane_dir() {
  local pane_id="$1"

  # Get pane path
  pane_path=$(tmux display-message -t "$pane_id" -p "#{pane_current_path}")
  echo $pane_path
}

function print_safe() {

  if [[ $safe_mode == "true" ]]; then
    echo -e "${GREEN}[SAFE MODE]${NC} About to run:" "$@"
    read -p "Proceed? [y/N] " confirm

    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
      echo -e "${RED}Operation cancelled by user.${NC}"
      exit -3
    fi
  fi

}

populate_array() {
  for item in "$@"; do
    if [[ $item == *"--"* ]]; then
      #echo "ez arg: $item"
      ez_flags_arr+=("$item")
    elif [[ $item == *"-"* ]]; then
      #echo "cmd arg: $item"
      flags_arr+=("$item")
    else
      #echo "args: $item"
      args_arr+=("$item")
    fi
  done
}

populate_array "$@"

function check_src() {

  for path in "${args_arr[@]}"; do
    if [[ ! -e $path ]]; then
      echo "Source file(s) do not exist."
      exit -6
    fi
  done
}

function check_target() {

  local target="$1"

  # check if target is in correct format
  if [[ ! "$target" =~ ^@ ]]; then
    echo "Target must be like @1 or @0.2"
    exit -4
  fi

  # get pane_path and check if it is not null
  pane_path="$(get_pane_dir "$target")"

  # check if var pane_path is null
  if [ -z "$pane_path" ]; then
    echo "Could not get pane path for pane id: $target"
    exit -5
  fi

}

function run_ez() {

  local cmd="${args_arr[0]}"
  unset 'args_arr[0]'
  safe_mode="false" # set safe mode to false by default

  for arg in "${ez_flags_arr[@]}"; do
    case "$arg" in
    --safe) safe_mode="true" ;;
    *) ;;
    esac
  done

  arg_str="${flags_arr[@]}"

  if [[ "$cmd" == "cd" ]]; then
    target="$2"
    check_target $target

    print_safe $cmd $pane_path

    tmux send-keys "cd $(printf %q "$pane_path")" C-m
    echo "[CD] $src -> $pane_path"

  elif [[ "$cmd" == "cp" ]]; then
    target="${args_arr[-1]}"
    unset 'args_arr[-1]'

    src_str="${args_arr[@]}"

    check_target $target
    check_src

    print_safe $cmd $src_str $pane_path $arg_str

    cp $src_str "$pane_path/" $arg_str
    echo "[COPY] $src_str -> $pane_path"

  elif [[ "$cmd" == "mv" ]]; then
    target="${args_arr[2]}"
    unset 'args_arr[-1]'

    src_str="${args_arr[@]}"

    check_target $target
    check_src

    print_safe $cmd $src_str $pane_path $arg_str

    mv $src_str "$pane_path/" $arg_str
    echo "[MOVE] $src_str -> $pane_path"

  else
    echo "Wrong command"
  fi
}

run_ez
